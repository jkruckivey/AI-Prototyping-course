<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas to SCORM Converter - Working</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #034638;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .features {
            background: rgba(255, 255, 255, 0.9);
            margin: 20px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .features h3 {
            color: #034638;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .features ul {
            list-style: none;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .features li {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            border-left: 4px solid #034638;
        }

        .controls {
            text-align: center;
            margin: 20px;
        }

        .controls button {
            background: #034638;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .controls button:hover {
            background: #582C83;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .controls .scorm-btn {
            background: #582C83;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section h3 {
            background: #034638;
            color: white;
            padding: 15px 20px;
            margin: 0;
            font-size: 1.2em;
        }

        .file-upload {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .file-upload label {
            display: inline-block;
            padding: 8px 16px;
            background: #034638;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .filename {
            margin-left: 10px;
            color: #666;
            font-size: 14px;
        }

        .batch-btn {
            display: none;
            margin-left: 10px;
            padding: 8px 16px;
            background: #582C83;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        textarea {
            width: 100%;
            height: 400px;
            border: none;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            resize: vertical;
            background: #fafafa;
        }

        textarea:focus {
            outline: none;
            background: white;
        }

        .status {
            margin: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            min-height: 20px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                margin: 10px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .controls button {
                display: block;
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéì Canvas to SCORM Converter</h1>
        <p>Convert Canvas LMS page fragments into complete, self-contained HTML documents for SCORM packages</p>
    </div>

    <div class="features">
        <h3>‚ú® What This Tool Does:</h3>
        <ul>
            <li>Embeds complete Canvas LMS CSS</li>
            <li>Bootstrap 4.6.2 framework</li>
            <li>AMBA template styling</li>
            <li>dp-wrapper Canvas classes</li>
            <li>FontAwesome icons</li>
            <li>Responsive design</li>
            <li>All necessary CSS embedded</li>
        </ul>
    </div>

    <div class="controls">
        <button onclick="convertToSCORM()">üîÑ Convert to SCORM</button>
        <button onclick="loadSamplePage()">üìù Load Sample Canvas Page</button>
        <button onclick="copyResult()">üìã Copy Result</button>
        <button onclick="downloadResult()">üíæ Download HTML File</button>
        <button onclick="downloadSCORMPackage()" class="scorm-btn">üì¶ Download SCORM Package</button>
        <button onclick="clearAll()">üóëÔ∏è Clear All</button>
    </div>

    <div class="container">
        <div class="section">
            <h3>üì• Input: Canvas Page HTML</h3>
            <div class="file-upload">
                <label for="fileInput">üìÅ Choose HTML File(s)
                    <input type="file" id="fileInput" accept=".html,.htm" multiple onchange="handleFileUpload(event)">
                </label>
                <span id="fileName" class="filename">or paste HTML below</span>
                <button onclick="processBatch()" id="batchBtn" class="batch-btn">üì¶ Process All as SCORM</button>
            </div>
            <textarea id="input" placeholder="Paste your Canvas page HTML here...

Example:
&lt;div id=&quot;dp-wrapper&quot; class=&quot;dp-wrapper&quot;&gt;
    &lt;div class=&quot;dp-content-block content-block&quot;&gt;
        &lt;h2&gt;Your Page Title&lt;/h2&gt;
        &lt;p&gt;Your content here&lt;/p&gt;
    &lt;/div&gt;
&lt;/div&gt;"></textarea>
        </div>

        <div class="section">
            <h3>üì§ Output: Complete SCORM-Ready HTML</h3>
            <textarea id="output" placeholder="Complete HTML document will appear here..." readonly></textarea>
        </div>
    </div>

    <div id="status" class="status"></div>

    <script>
        var uploadedFiles = [];

        function showStatus(message, type) {
            var statusDiv = document.getElementById('status');
            statusDiv.className = 'status ' + type;
            statusDiv.textContent = message;
        }

        function getCanvasCSS() {
            return '/* Canvas LMS + AMBA Template CSS for SCORM */\n\n' +
            '/* Import FontAwesome for proper icon display */\n' +
            '@import url("https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css");\n\n' +
            '/* Reset and Base Styles */\n' +
            '* { box-sizing: border-box; }\n\n' +
            'body {\n' +
            '    font-family: "Lato", "Helvetica Neue", Helvetica, Arial, sans-serif;\n' +
            '    font-size: 14px;\n' +
            '    line-height: 1.4;\n' +
            '    color: #2D3B45;\n' +
            '    background-color: #f5f5f5;\n' +
            '    margin: 0;\n' +
            '    padding: 20px;\n' +
            '}\n\n' +
            '/* Canvas LMS dp-wrapper Framework */\n' +
            '.dp-wrapper {\n' +
            '    max-width: 1200px;\n' +
            '    margin: 0 auto;\n' +
            '    background: white;\n' +
            '    border-radius: 8px;\n' +
            '    box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n' +
            '    overflow: hidden;\n' +
            '}\n\n' +
            '.dp-content-block, .content-block {\n' +
            '    padding: 30px;\n' +
            '    border-bottom: 1px solid #e1e8ed;\n' +
            '}\n\n' +
            '.dp-content-block:last-child { border-bottom: none; }\n\n' +
            '/* Typography */\n' +
            'h1, h2, h3, h4, h5, h6 {\n' +
            '    font-weight: bold;\n' +
            '    line-height: 1.2;\n' +
            '    margin-top: 20px;\n' +
            '    margin-bottom: 10px;\n' +
            '    color: #2D3B45;\n' +
            '}\n\n' +
            'h2:first-child, h3:first-child { margin-top: 0; }\n' +
            'h1 { font-size: 2.5rem; }\n' +
            'h2 { font-size: 2rem; color: #034638; }\n' +
            'h3 { font-size: 1.75rem; }\n' +
            'p { margin-bottom: 15px; line-height: 1.6; }\n\n' +
            '/* Canvas Cards */\n' +
            '.dp-card, .card {\n' +
            '    background-color: #fff;\n' +
            '    border: 1px solid rgba(0,0,0,.125);\n' +
            '    border-radius: 0.375rem;\n' +
            '    margin-bottom: 15px;\n' +
            '}\n\n' +
            '.card-body { padding: 1.25rem; }\n' +
            '.card-title { font-size: 1.25rem; font-weight: 500; }\n\n' +
            '/* Canvas Collapsibles */\n' +
            '.canvas-collapsible {\n' +
            '    border: 1px solid #c7cdd1;\n' +
            '    margin-bottom: 15px;\n' +
            '    background: #f5f5f5;\n' +
            '}\n\n' +
            '.canvas-collapsible summary {\n' +
            '    padding: 12px 16px;\n' +
            '    background: #f5f5f5;\n' +
            '    color: #2d3b45;\n' +
            '    cursor: pointer;\n' +
            '    font-weight: normal;\n' +
            '    list-style: none;\n' +
            '}\n\n' +
            '.canvas-collapsible .content,\n' +
            '.canvas-collapsible .collapsible-content {\n' +
            '    padding: 16px;\n' +
            '    background: white;\n' +
            '}\n\n' +
            '/* Canvas Tables */\n' +
            '.ic-Table {\n' +
            '    width: 100%;\n' +
            '    border-collapse: collapse;\n' +
            '}\n\n' +
            '.ic-Table th, .ic-Table td {\n' +
            '    padding: 0.75rem;\n' +
            '    border-top: 1px solid #dee2e6;\n' +
            '}\n\n' +
            '.ic-Table thead th {\n' +
            '    background-color: #f8f9fa;\n' +
            '    font-weight: bold;\n' +
            '}\n\n' +
            '/* FontAwesome Icons */\n' +
            '.fas, .far, .fab { color: #034638 !important; }\n' +
            '.dp-has-icon { display: flex; align-items: center; }\n' +
            '.dp-icon { margin-right: 10px; color: #034638 !important; }\n\n' +
            '/* Lists */\n' +
            '.list-group { display: flex; flex-direction: column; }\n' +
            '.list-group-item {\n' +
            '    padding: 0.75rem 1.25rem;\n' +
            '    background-color: #fff;\n' +
            '    border: 1px solid rgba(0,0,0,.125);\n' +
            '}\n\n' +
            '/* Responsive */\n' +
            '@media (max-width: 768px) {\n' +
            '    .dp-wrapper { margin: 10px; }\n' +
            '    .dp-content-block { padding: 20px 15px; }\n' +
            '}';
        }

        function convertToSCORM() {
            var input = document.getElementById('input').value.trim();

            if (!input) {
                showStatus('Please paste your Canvas page HTML first.', 'error');
                return;
            }

            if (input.indexOf('dp-wrapper') === -1) {
                showStatus('HTML does not appear to be a Canvas page (missing dp-wrapper).', 'warning');
            }

            try {
                // Replace emoji with FontAwesome icons
                var emojiMap = {
                    'üóÑÔ∏è': '<i class="dp-icon fas fa-database"></i>',
                    'üõ£Ô∏è': '<i class="dp-icon fas fa-route"></i>',
                    'üí°': '<i class="dp-icon fas fa-lightbulb"></i>',
                    'üìà': '<i class="dp-icon fas fa-chart-line"></i>',
                    'üë•': '<i class="dp-icon fas fa-users"></i>',
                    '‚öôÔ∏è': '<i class="dp-icon fas fa-cog"></i>',
                    'üìö': '<i class="dp-icon fas fa-book"></i>',
                    'üéì': '<i class="dp-icon fas fa-graduation-cap"></i>',
                    'üöÄ': '<i class="dp-icon fas fa-rocket"></i>',
                    'üéØ': '<i class="dp-icon fas fa-bullseye"></i>',
                    'üß†': '<i class="dp-icon fas fa-brain"></i>',
                    'üîç': '<i class="dp-icon fas fa-search"></i>'
                };

                for (var emoji in emojiMap) {
                    var regex = new RegExp(emoji, 'g');
                    input = input.replace(regex, emojiMap[emoji]);
                }

                // Extract title
                var title = 'Canvas Page';
                var titleMatch = input.match(/<h2[^>]*>.*?<\/h2>/i);
                if (titleMatch) {
                    var titleText = titleMatch[0].replace(/<[^>]*>/g, '').replace(/&[^;]+;/g, '').trim();
                    if (titleText) title = titleText;
                }

                // Create complete HTML
                var html = '<!DOCTYPE html>\n';
                html += '<html lang="en">\n';
                html += '<head>\n';
                html += '<meta charset="UTF-8">\n';
                html += '<meta name="viewport" content="width=device-width, initial-scale=1.0">\n';
                html += '<title>' + title + '</title>\n';
                html += '<style>\n';
                html += getCanvasCSS();
                html += '\n</style>\n';
                html += '</head>\n';
                html += '<body>\n';
                html += input;
                html += '\n</body>\n';
                html += '</html>';

                document.getElementById('output').value = html;
                showStatus('‚úÖ Successfully converted to complete HTML document!', 'success');

            } catch (error) {
                showStatus('Error converting HTML: ' + error.message, 'error');
            }
        }

        function handleFileUpload(event) {
            var files = event.target.files;
            if (!files || files.length === 0) return;

            uploadedFiles = [];

            if (files.length === 1) {
                // Single file
                var file = files[0];
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('batchBtn').style.display = 'none';

                if (!file.name.match(/\.(html|htm)$/i)) {
                    showStatus('Please select an HTML file.', 'error');
                    return;
                }

                var reader = new FileReader();
                reader.onload = function(e) {
                    var content = e.target.result;

                    // Extract body content if full HTML
                    if (content.includes('<!DOCTYPE') || content.includes('<html')) {
                        var bodyMatch = content.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
                        if (bodyMatch) {
                            content = bodyMatch[1];
                            content = content.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
                        }
                    }

                    document.getElementById('input').value = content;
                    showStatus('‚úÖ File loaded successfully!', 'success');
                };

                reader.readAsText(file);
            } else {
                // Multiple files
                document.getElementById('fileName').textContent = files.length + ' files selected';
                document.getElementById('batchBtn').style.display = 'inline-block';

                for (var i = 0; i < files.length; i++) {
                    uploadedFiles.push(files[i]);
                }

                showStatus('üìö ' + files.length + ' files ready for batch processing.', 'success');
                document.getElementById('input').value = 'Multiple files selected. Click "Process All as SCORM" to create individual SCORM packages.';
            }
        }

        function processBatch() {
            if (uploadedFiles.length === 0) {
                showStatus('No files to process.', 'error');
                return;
            }

            showStatus('Processing ' + uploadedFiles.length + ' files...', 'success');

            uploadedFiles.forEach(function(file, index) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var content = e.target.result;

                    if (content.includes('<!DOCTYPE') || content.includes('<html')) {
                        var bodyMatch = content.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
                        if (bodyMatch) {
                            content = bodyMatch[1];
                            content = content.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
                        }
                    }

                    setTimeout(function() {
                        createSCORMFromContent(content, file.name.replace(/\.(html|htm)$/i, ''));
                    }, index * 500);
                };

                reader.readAsText(file);
            });
        }

        function createSCORMFromContent(htmlContent, filename) {
            // Apply emoji replacements
            var emojiMap = {
                'üóÑÔ∏è': '<i class="dp-icon fas fa-database"></i>',
                'üõ£Ô∏è': '<i class="dp-icon fas fa-route"></i>',
                'üí°': '<i class="dp-icon fas fa-lightbulb"></i>'
            };

            for (var emoji in emojiMap) {
                htmlContent = htmlContent.replace(new RegExp(emoji, 'g'), emojiMap[emoji]);
            }

            // Create HTML
            var html = '<!DOCTYPE html>\n<html lang="en">\n<head>\n';
            html += '<meta charset="UTF-8">\n<title>' + filename + '</title>\n<style>\n';
            html += getCanvasCSS() + '\n</style>\n</head>\n<body>\n';
            html += htmlContent + '\n<script src="scormfunctions.js"></script>\n</body>\n</html>';

            // Create ZIP
            var zip = new JSZip();
            zip.file("imsmanifest.xml", generateSCORMManifest(filename));
            zip.file("index.html", html);
            zip.file("scormfunctions.js", getSCORMFunctions());

            zip.generateAsync({type:"blob"}).then(function(content) {
                saveAs(content, "scorm-" + filename + ".zip");
            });
        }

        function loadSamplePage() {
            var sample = '<div id="dp-wrapper" class="dp-wrapper">\n';
            sample += '    <div class="dp-content-block content-block">\n';
            sample += '        <h2 class="dp-has-icon"><i class="dp-icon fas fa-graduation-cap"></i>&nbsp;Sample Learning Module</h2>\n';
            sample += '        <p>This is a sample Canvas LMS page fragment.</p>\n';
            sample += '        <details class="canvas-collapsible" open>\n';
            sample += '            <summary>Learning Content</summary>\n';
            sample += '            <div class="content">\n';
            sample += '                <p>This is collapsible content.</p>\n';
            sample += '            </div>\n';
            sample += '        </details>\n';
            sample += '    </div>\n';
            sample += '</div>';

            document.getElementById('input').value = sample;
            showStatus('üìù Sample Canvas page loaded.', 'success');
        }

        function copyResult() {
            var output = document.getElementById('output');
            if (!output.value) {
                showStatus('No output to copy. Convert a page first.', 'warning');
                return;
            }

            output.select();
            output.setSelectionRange(0, 99999);
            document.execCommand('copy');
            showStatus('‚úÖ Complete HTML copied to clipboard!', 'success');
        }

        function downloadResult() {
            var output = document.getElementById('output').value;
            if (!output) {
                showStatus('No output to download. Convert a page first.', 'warning');
                return;
            }

            var blob = new Blob([output], { type: 'text/html' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'canvas-page-scorm-ready.html';
            a.click();
            URL.revokeObjectURL(url);
            showStatus('‚úÖ SCORM-ready HTML file downloaded!', 'success');
        }

        function downloadSCORMPackage() {
            var output = document.getElementById('output').value;
            if (!output) {
                showStatus('No output to package. Convert a page first.', 'warning');
                return;
            }

            // Extract title
            var title = 'Canvas Page';
            var titleMatch = output.match(/<title>(.*?)<\/title>/i);
            if (titleMatch) {
                title = titleMatch[1];
            }

            // Add SCORM tracking
            var scormHTML = output.replace('</body>', '<script src="scormfunctions.js"></script>\n</body>');

            // Create ZIP
            var zip = new JSZip();
            zip.file("imsmanifest.xml", generateSCORMManifest(title));
            zip.file("index.html", scormHTML);
            zip.file("scormfunctions.js", getSCORMFunctions());

            zip.generateAsync({type:"blob"}).then(function(content) {
                saveAs(content, "scorm-package-" + Date.now() + ".zip");
                showStatus('‚úÖ SCORM package downloaded!', 'success');
            });
        }

        function generateSCORMManifest(title) {
            var manifest = '<?xml version="1.0" encoding="UTF-8"?>\n';
            manifest += '<manifest identifier="com.canvas.scorm.' + Date.now() + '" version="1"\n';
            manifest += '          xmlns="http://www.imsproject.org/xsd/imscp_rootv1p1p2"\n';
            manifest += '          xmlns:adlcp="http://www.adlnet.org/xsd/adlcp_rootv1p2">\n';
            manifest += '  <metadata>\n';
            manifest += '    <schema>ADL SCORM</schema>\n';
            manifest += '    <schemaversion>1.2</schemaversion>\n';
            manifest += '  </metadata>\n';
            manifest += '  <organizations default="org1">\n';
            manifest += '    <organization identifier="org1">\n';
            manifest += '      <title>' + title + '</title>\n';
            manifest += '      <item identifier="item1" identifierref="resource1">\n';
            manifest += '        <title>' + title + '</title>\n';
            manifest += '      </item>\n';
            manifest += '    </organization>\n';
            manifest += '  </organizations>\n';
            manifest += '  <resources>\n';
            manifest += '    <resource identifier="resource1" type="webcontent" adlcp:scormtype="sco" href="index.html">\n';
            manifest += '      <file href="index.html"/>\n';
            manifest += '      <file href="scormfunctions.js"/>\n';
            manifest += '    </resource>\n';
            manifest += '  </resources>\n';
            manifest += '</manifest>';
            return manifest;
        }

        function getSCORMFunctions() {
            return '// SCORM 1.2 API Wrapper\n' +
            'var SCORM_API = null;\n' +
            'var SCORM_initialized = false;\n' +
            'var pageStartTime = new Date();\n\n' +
            'function findAPI(win) {\n' +
            '    var findAPITries = 0;\n' +
            '    while ((win.API == null) && (win.parent != null) && (win.parent != win)) {\n' +
            '        findAPITries++;\n' +
            '        if (findAPITries > 7) return null;\n' +
            '        win = win.parent;\n' +
            '    }\n' +
            '    return win.API;\n' +
            '}\n\n' +
            'function SCORM_Initialize() {\n' +
            '    SCORM_API = findAPI(window);\n' +
            '    if (SCORM_API != null) {\n' +
            '        SCORM_initialized = SCORM_API.LMSInitialize("");\n' +
            '        if (SCORM_initialized) {\n' +
            '            SCORM_API.LMSSetValue("cmi.core.lesson_status", "incomplete");\n' +
            '            SCORM_API.LMSCommit("");\n' +
            '        }\n' +
            '    }\n' +
            '}\n\n' +
            'function SCORM_SetComplete() {\n' +
            '    if (SCORM_API != null && SCORM_initialized) {\n' +
            '        SCORM_API.LMSSetValue("cmi.core.lesson_status", "completed");\n' +
            '        SCORM_API.LMSCommit("");\n' +
            '    }\n' +
            '}\n\n' +
            'window.addEventListener("load", SCORM_Initialize);\n' +
            'window.addEventListener("scroll", function() {\n' +
            '    var scrollPercent = (window.pageYOffset / (document.documentElement.scrollHeight - window.innerHeight)) * 100;\n' +
            '    if (scrollPercent > 90) SCORM_SetComplete();\n' +
            '});';
        }

        function clearAll() {
            document.getElementById('input').value = '';
            document.getElementById('output').value = '';
            document.getElementById('status').textContent = '';
            document.getElementById('fileName').textContent = 'or paste HTML below';
            document.getElementById('batchBtn').style.display = 'none';
            uploadedFiles = [];
        }
    </script>
</body>
</html>