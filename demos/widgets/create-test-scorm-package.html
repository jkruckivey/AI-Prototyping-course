<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Test SCORM Package</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        h1 {
            color: #034638;
            margin-bottom: 20px;
        }
        .btn {
            background: #034638;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        .btn:hover {
            background: #025a44;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ Create Test SCORM Package</h1>
        <p>This will create a SCORM package from the test combined widget file.</p>
        <button class="btn" onclick="createSCORMPackage()">Create SCORM Package</button>
        <div id="status"></div>
    </div>

    <script>
        function generateSCORMManifest() {
            var manifest = `<?xml version="1.0" encoding="UTF-8"?>
<manifest identifier="com.canvas.scorm.${Date.now()}" version="1"
          xmlns="http://www.imsproject.org/xsd/imscp_rootv1p1p2"
          xmlns:adlcp="http://www.adlnet.org/xsd/adlcp_rootv1p2"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://www.imsproject.org/xsd/imscp_rootv1p1p2 imscp_rootv1p1p2.xsd
                              http://www.imsglobal.org/xsd/imsmd_rootv1p2p1 imsmd_rootv1p2p1.xsd
                              http://www.adlnet.org/xsd/adlcp_rootv1p2 adlcp_rootv1p2.xsd">
  <metadata>
    <schema>ADL SCORM</schema>
    <schemaversion>1.2</schemaversion>
  </metadata>
  <organizations default="org1">
    <organization identifier="org1">
      <title>Understanding Data - Customer Segmentation</title>
      <item identifier="item1" identifierref="resource1">
        <title>Understanding Data - Customer Segmentation</title>
      </item>
    </organization>
  </organizations>
  <resources>
    <resource identifier="resource1" type="webcontent" adlcp:scormtype="sco" href="index.html">
      <file href="index.html"/>
      <file href="scormfunctions.js"/>
    </resource>
  </resources>
</manifest>`;
            return manifest;
        }

        function getSCORMFunctions() {
            return `// SCORM 1.2 API Wrapper for Test Package
var SCORM_API = null;
var SCORM_initialized = false;
var SCORM_finished = false;
var pageStartTime = new Date();

// Find the SCORM API
function findAPI(win) {
    var findAPITries = 0;
    while ((win.API == null) && (win.parent != null) && (win.parent != win)) {
        findAPITries++;
        if (findAPITries > 7) return null;
        win = win.parent;
    }
    return win.API;
}

function getAPI() {
    var theAPI = findAPI(window);
    if ((theAPI == null) && (window.opener != null) && (typeof(window.opener) != "undefined")) {
        theAPI = findAPI(window.opener);
    }
    return theAPI;
}

// Initialize SCORM connection
function SCORM_Initialize() {
    SCORM_API = getAPI();

    if (SCORM_API != null) {
        SCORM_initialized = SCORM_API.LMSInitialize("");
        if (SCORM_initialized) {
            SCORM_API.LMSSetValue("cmi.core.lesson_status", "incomplete");
            SCORM_API.LMSCommit("");
            trackPageView();
            return true;
        }
    }
    return false;
}

// Track time spent
function SCORM_SetSessionTime() {
    if (SCORM_API != null && SCORM_initialized) {
        var now = new Date();
        var seconds = Math.round((now - pageStartTime) / 1000);
        var timeStr = convertSecondsToSCORMTime(seconds);
        SCORM_API.LMSSetValue("cmi.core.session_time", timeStr);
        SCORM_API.LMSCommit("");
    }
}

// Convert seconds to SCORM time format (HH:MM:SS)
function convertSecondsToSCORMTime(seconds) {
    var hours = Math.floor(seconds / 3600);
    var mins = Math.floor((seconds % 3600) / 60);
    var secs = seconds % 60;

    return pad(hours) + ":" + pad(mins) + ":" + pad(secs);
}

function pad(num) {
    return (num < 10 ? "0" : "") + num;
}

// Track page view
function trackPageView() {
    if (SCORM_API != null && SCORM_initialized) {
        SCORM_API.LMSSetValue("cmi.core.lesson_location", window.location.href);
        SCORM_API.LMSCommit("");
    }
}

// Track widget interactions
function trackWidgetInteraction(widgetName, value) {
    if (SCORM_API != null && SCORM_initialized) {
        var interactionCount = SCORM_API.LMSGetValue("cmi.interactions._count");
        if (interactionCount == "") interactionCount = 0;

        SCORM_API.LMSSetValue("cmi.interactions." + interactionCount + ".id", widgetName);
        SCORM_API.LMSSetValue("cmi.interactions." + interactionCount + ".type", "other");
        SCORM_API.LMSSetValue("cmi.interactions." + interactionCount + ".student_response", value);
        SCORM_API.LMSSetValue("cmi.interactions." + interactionCount + ".result", "neutral");
        SCORM_API.LMSSetValue("cmi.interactions." + interactionCount + ".time", getCurrentTime());

        SCORM_API.LMSCommit("");
    }
}

// Mark as complete
function SCORM_SetComplete() {
    if (SCORM_API != null && SCORM_initialized) {
        var status = SCORM_API.LMSGetValue("cmi.core.lesson_status");
        if (status != "passed" && status != "failed") {
            SCORM_API.LMSSetValue("cmi.core.lesson_status", "completed");
        }
        SCORM_SetSessionTime();
        SCORM_API.LMSCommit("");
    }
}

// Finish SCORM session
function SCORM_Finish() {
    if (SCORM_API != null && SCORM_initialized && !SCORM_finished) {
        SCORM_SetSessionTime();
        SCORM_API.LMSCommit("");
        SCORM_API.LMSFinish("");
        SCORM_finished = true;
    }
}

// Helper function
function getCurrentTime() {
    var d = new Date();
    return pad(d.getHours()) + ":" + pad(d.getMinutes()) + ":" + pad(d.getSeconds());
}

// Track scroll progress
var maxScroll = 0;
function trackScrollProgress() {
    var scrollPercent = (window.pageYOffset / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
    if (scrollPercent > maxScroll) {
        maxScroll = scrollPercent;
        if (maxScroll > 90) {
            SCORM_SetComplete();
        }
    }
}

// Initialize when page loads
window.addEventListener('load', function() {
    SCORM_Initialize();
    window.addEventListener('scroll', trackScrollProgress);

    // Track segment card interactions
    var segmentCards = document.querySelectorAll('.segment-card');
    segmentCards.forEach(function(card) {
        card.addEventListener('click', function() {
            var segment = card.getAttribute('data-segment');
            trackWidgetInteraction('customer_segment_' + segment, 'viewed');
        });
    });

    // Track show all button
    var showAllBtn = document.getElementById('showAllBtn');
    if (showAllBtn) {
        showAllBtn.addEventListener('click', function() {
            trackWidgetInteraction('show_all_segments', 'clicked');
        });
    }
});

// Save progress periodically
setInterval(function() {
    if (SCORM_initialized) {
        SCORM_SetSessionTime();
    }
}, 60000); // Every minute

// Finish when page unloads
window.addEventListener('beforeunload', function() {
    SCORM_Finish();
});`;
        }

        function createSCORMPackage() {
            // Load the test combined widget file
            fetch('./test-combined-content-widget.html')
                .then(response => response.text())
                .then(htmlContent => {
                    // Fix scrollbar issues for SCORM iframe display
                    var fixedHTML = htmlContent
                        .replace('body {', 'body {\n            overflow-x: hidden;\n            min-height: 100vh;')
                        .replace('padding: 20px;', 'padding: 10px;')
                        .replace('</head>', '    <style>\n        /* SCORM iframe fixes */\n        html, body {\n            height: 100%;\n            overflow-x: hidden;\n        }\n        .dp-wrapper {\n            min-height: calc(100vh - 40px);\n            height: auto;\n        }\n    </style>\n</head>');

                    // Add SCORM tracking script before closing body tag
                    var scormHTML = fixedHTML.replace('</body>', '<script src="scormfunctions.js"></script>\n</body>');

                    // Create ZIP file
                    var zip = new JSZip();

                    // Add the manifest
                    zip.file("imsmanifest.xml", generateSCORMManifest());

                    // Add the HTML content as index.html
                    zip.file("index.html", scormHTML);

                    // Add SCORM functions
                    zip.file("scormfunctions.js", getSCORMFunctions());

                    // Generate and download the ZIP
                    zip.generateAsync({type:"blob"})
                        .then(function(content) {
                            saveAs(content, "understanding-data-scorm-test.zip");
                            document.getElementById('status').innerHTML = '<div class="success">‚úÖ SCORM package created! Upload "understanding-data-scorm-test.zip" to Canvas Learn.</div>';
                        });
                })
                .catch(error => {
                    document.getElementById('status').innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px;">‚ùå Error: Could not load test file. Make sure test-combined-content-widget.html is in the same folder.</div>';
                });
        }
    </script>
</body>
</html>