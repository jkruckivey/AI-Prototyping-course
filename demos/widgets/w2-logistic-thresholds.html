<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistic Regression Threshold Tuner</title>
    <link rel="stylesheet" href="../shared-demo.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .threshold-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 1rem 0;
        }

        .controls-section {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-group {
            margin: 1rem 0;
        }

        .control-group label {
            font-weight: 600;
            display: block;
            margin-bottom: 0.5rem;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .slider-container input[type="range"] {
            flex: 1;
        }

        .value-display {
            background: #e7f3ff;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: bold;
            min-width: 70px;
            text-align: center;
        }

        .threshold-line {
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
            border-radius: 4px;
            position: relative;
            margin: 1rem 0;
        }

        .threshold-indicator {
            position: absolute;
            top: -4px;
            width: 16px;
            height: 16px;
            background: #034638;
            border: 2px solid white;
            border-radius: 50%;
            transform: translateX(-50%);
            transition: left 0.3s ease;
        }

        .scenario-selector {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .scenario-btn {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .scenario-btn.active {
            background: #034638;
            color: white;
            border-color: #034638;
        }

        .metrics-section {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #034638;
            text-align: center;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #034638;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .metric-description {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
            line-height: 1.3;
        }

        .confusion-matrix {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
            max-width: 300px;
        }

        .cm-header {
            background: #f3f4f6;
            padding: 0.5rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        .cm-cell {
            background: white;
            border: 2px solid #e5e7eb;
            padding: 0.75rem;
            text-align: center;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .cm-cell.tp { border-color: #10b981; background: #ecfdf5; }
        .cm-cell.fp { border-color: #ef4444; background: #fef2f2; }
        .cm-cell.fn { border-color: #f59e0b; background: #fffbeb; }
        .cm-cell.tn { border-color: #3b82f6; background: #eff6ff; }

        .cm-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .cm-label {
            font-size: 0.7rem;
            margin-top: 0.25rem;
        }

        .plot-container {
            height: 300px;
            margin: 1rem 0;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }

        .cost-analysis {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .cost-breakdown {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0.5rem 0;
        }

        .cost-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cost-value {
            font-weight: bold;
            color: #dc2626;
        }

        .scenario-info {
            background: #e7f3ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .threshold-container {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="demo-header">
            <h1>Logistic Regression Threshold Tuner</h1>
            <p>Adjust the decision threshold and see how precision, recall, and business costs change</p>
        </div>

        <div class="scenario-info" id="scenario-info">
            <strong>üìß Email Spam Detection</strong><br>
            Classifying emails as spam (positive) or legitimate (negative). False positives (legitimate emails marked as spam) are costly!
        </div>

        <div class="threshold-container">
            <div class="controls-section">
                <h3>‚öôÔ∏è Controls</h3>

                <div class="control-group">
                    <label>Scenario:</label>
                    <div class="scenario-selector">
                        <button class="scenario-btn active" onclick="selectScenario('spam')">Email Spam</button>
                        <button class="scenario-btn" onclick="selectScenario('fraud')">Fraud Detection</button>
                        <button class="scenario-btn" onclick="selectScenario('medical')">Medical Screening</button>
                        <button class="scenario-btn" onclick="selectScenario('loan')">Loan Approval</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Decision Threshold:</label>
                    <div class="slider-container">
                        <input type="range" id="threshold-slider" min="0.1" max="0.9" value="0.5" step="0.05" onchange="updateThreshold(this.value)">
                        <div class="value-display" id="threshold-value">0.50</div>
                    </div>
                    <div class="threshold-line">
                        <div class="threshold-indicator" id="threshold-indicator"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #666;">
                        <span>Conservative</span>
                        <span>Balanced</span>
                        <span>Aggressive</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Class Balance:</label>
                    <div class="slider-container">
                        <input type="range" id="balance-slider" min="5" max="50" value="20" onchange="updateBalance(this.value)">
                        <div class="value-display" id="balance-value">20%</div>
                    </div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
                        Percentage of positive cases in the dataset
                    </div>
                </div>

                <h4>Confusion Matrix</h4>
                <div class="confusion-matrix">
                    <div class="cm-header"></div>
                    <div class="cm-header">Predicted<br>Negative</div>
                    <div class="cm-header">Predicted<br>Positive</div>

                    <div class="cm-header">Actual<br>Negative</div>
                    <div class="cm-cell tn" id="tn-cell">
                        <div class="cm-value" id="tn-value">760</div>
                        <div class="cm-label">True Negatives</div>
                    </div>
                    <div class="cm-cell fp" id="fp-cell">
                        <div class="cm-value" id="fp-value">40</div>
                        <div class="cm-label">False Positives</div>
                    </div>

                    <div class="cm-header">Actual<br>Positive</div>
                    <div class="cm-cell fn" id="fn-cell">
                        <div class="cm-value" id="fn-value">60</div>
                        <div class="cm-label">False Negatives</div>
                    </div>
                    <div class="cm-cell tp" id="tp-cell">
                        <div class="cm-value" id="tp-value">140</div>
                        <div class="cm-label">True Positives</div>
                    </div>
                </div>
            </div>

            <div class="metrics-section">
                <h3>üìä Performance Metrics</h3>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="precision-value">77.8%</div>
                        <div class="metric-label">Precision</div>
                        <div class="metric-description">Of predicted positives, how many are actually positive?</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-value" id="recall-value">70.0%</div>
                        <div class="metric-label">Recall (Sensitivity)</div>
                        <div class="metric-description">Of actual positives, how many did we catch?</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-value" id="specificity-value">95.0%</div>
                        <div class="metric-label">Specificity</div>
                        <div class="metric-description">Of actual negatives, how many did we correctly identify?</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-value" id="f1-value">73.7%</div>
                        <div class="metric-label">F1 Score</div>
                        <div class="metric-description">Harmonic mean of precision and recall</div>
                    </div>
                </div>

                <div class="plot-container" id="roc-plot"></div>

                <div class="cost-analysis">
                    <h4>üí∞ Business Cost Analysis</h4>
                    <div class="cost-breakdown">
                        <div class="cost-item">
                            <span>False Positives:</span>
                            <span class="cost-value" id="fp-cost">$200</span>
                        </div>
                        <div class="cost-item">
                            <span>False Negatives:</span>
                            <span class="cost-value" id="fn-cost">$180</span>
                        </div>
                    </div>
                    <div style="border-top: 2px solid #ffeaa7; margin-top: 1rem; padding-top: 1rem;">
                        <div class="cost-breakdown">
                            <div class="cost-item">
                                <span><strong>Total Cost:</strong></span>
                                <span class="cost-value" id="total-cost" style="font-size: 1.2rem;">$380</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentScenario = 'spam';
        let threshold = 0.5;
        let positiveRate = 0.2; // Class balance
        let totalSamples = 1000;

        const scenarios = {
            spam: {
                name: 'üìß Email Spam Detection',
                description: 'Classifying emails as spam (positive) or legitimate (negative). False positives (legitimate emails marked as spam) are costly!',
                fpCost: 5, // Cost per false positive
                fnCost: 1, // Cost per false negative
                positiveLabel: 'Spam',
                negativeLabel: 'Legitimate'
            },
            fraud: {
                name: 'üí≥ Fraud Detection',
                description: 'Detecting fraudulent transactions (positive) vs legitimate ones (negative). Missing fraud is very expensive!',
                fpCost: 10,
                fnCost: 100,
                positiveLabel: 'Fraud',
                negativeLabel: 'Legitimate'
            },
            medical: {
                name: 'ü©∫ Medical Screening',
                description: 'Screening for disease (positive) vs healthy (negative). Missing a disease can be life-threatening!',
                fpCost: 50,
                fnCost: 500,
                positiveLabel: 'Disease',
                negativeLabel: 'Healthy'
            },
            loan: {
                name: 'üè¶ Loan Approval',
                description: 'Approving loans (positive) vs denying (negative). Bad loans are costly, but missed good customers hurt revenue!',
                fpCost: 1000,
                fnCost: 200,
                positiveLabel: 'Approve',
                negativeLabel: 'Deny'
            }
        };

        function selectScenario(scenario) {
            currentScenario = scenario;

            // Update button states
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update scenario info
            const info = scenarios[scenario];
            document.getElementById('scenario-info').innerHTML = `<strong>${info.name}</strong><br>${info.description}`;

            updateMetrics();
            updateROCCurve();
        }

        function updateThreshold(value) {
            threshold = parseFloat(value);
            document.getElementById('threshold-value').textContent = threshold.toFixed(2);

            // Update visual indicator
            const indicator = document.getElementById('threshold-indicator');
            const percentage = ((threshold - 0.1) / 0.8) * 100;
            indicator.style.left = percentage + '%';

            updateMetrics();
        }

        function updateBalance(value) {
            positiveRate = parseInt(value) / 100;
            document.getElementById('balance-value').textContent = value + '%';
            updateMetrics();
        }

        function calculateConfusionMatrix() {
            // Simulate logistic regression probability distribution
            const actualPositives = Math.round(totalSamples * positiveRate);
            const actualNegatives = totalSamples - actualPositives;

            // Simulate prediction probabilities
            // Positives have higher average probability
            let tp = 0, fp = 0, fn = 0, tn = 0;

            // For positive samples
            for(let i = 0; i < actualPositives; i++) {
                const prob = Math.max(0, Math.min(1, 0.7 + (Math.random() - 0.5) * 0.4)); // Centered around 0.7
                if(prob >= threshold) {
                    tp++;
                } else {
                    fn++;
                }
            }

            // For negative samples
            for(let i = 0; i < actualNegatives; i++) {
                const prob = Math.max(0, Math.min(1, 0.3 + (Math.random() - 0.5) * 0.4)); // Centered around 0.3
                if(prob >= threshold) {
                    fp++;
                } else {
                    tn++;
                }
            }

            return { tp, fp, fn, tn };
        }

        function updateMetrics() {
            const { tp, fp, fn, tn } = calculateConfusionMatrix();

            // Update confusion matrix display
            document.getElementById('tp-value').textContent = tp;
            document.getElementById('fp-value').textContent = fp;
            document.getElementById('fn-value').textContent = fn;
            document.getElementById('tn-value').textContent = tn;

            // Calculate metrics
            const precision = tp > 0 ? (tp / (tp + fp)) : 0;
            const recall = tp > 0 ? (tp / (tp + fn)) : 0;
            const specificity = tn > 0 ? (tn / (tn + fp)) : 0;
            const f1 = (precision + recall) > 0 ? (2 * precision * recall) / (precision + recall) : 0;

            // Update metric displays
            document.getElementById('precision-value').textContent = (precision * 100).toFixed(1) + '%';
            document.getElementById('recall-value').textContent = (recall * 100).toFixed(1) + '%';
            document.getElementById('specificity-value').textContent = (specificity * 100).toFixed(1) + '%';
            document.getElementById('f1-value').textContent = (f1 * 100).toFixed(1) + '%';

            // Calculate costs
            const scenario = scenarios[currentScenario];
            const fpCost = fp * scenario.fpCost;
            const fnCost = fn * scenario.fnCost;
            const totalCost = fpCost + fnCost;

            document.getElementById('fp-cost').textContent = '$' + fpCost.toLocaleString();
            document.getElementById('fn-cost').textContent = '$' + fnCost.toLocaleString();
            document.getElementById('total-cost').textContent = '$' + totalCost.toLocaleString();
        }

        function updateROCCurve() {
            const thresholds = [];
            const tprValues = [];
            const fprValues = [];

            // Generate ROC curve points
            for(let t = 0.05; t <= 0.95; t += 0.05) {
                const { tp, fp, fn, tn } = simulateAtThreshold(t);
                const tpr = tp > 0 ? tp / (tp + fn) : 0; // True Positive Rate (Recall)
                const fpr = fp > 0 ? fp / (fp + tn) : 0; // False Positive Rate

                thresholds.push(t);
                tprValues.push(tpr);
                fprValues.push(fpr);
            }

            // Current threshold point
            const currentMetrics = calculateConfusionMatrix();
            const currentTPR = currentMetrics.tp > 0 ? currentMetrics.tp / (currentMetrics.tp + currentMetrics.fn) : 0;
            const currentFPR = currentMetrics.fp > 0 ? currentMetrics.fp / (currentMetrics.fp + currentMetrics.tn) : 0;

            const traces = [
                {
                    x: fprValues,
                    y: tprValues,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'ROC Curve',
                    line: { color: '#034638', width: 3 }
                },
                {
                    x: [0, 1],
                    y: [0, 1],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Random Classifier',
                    line: { color: '#9ca3af', dash: 'dash' }
                },
                {
                    x: [currentFPR],
                    y: [currentTPR],
                    type: 'scatter',
                    mode: 'markers',
                    name: `Current Threshold (${threshold.toFixed(2)})`,
                    marker: { color: '#ef4444', size: 12 }
                }
            ];

            const layout = {
                title: 'ROC Curve',
                xaxis: {
                    title: 'False Positive Rate',
                    range: [0, 1]
                },
                yaxis: {
                    title: 'True Positive Rate (Recall)',
                    range: [0, 1]
                },
                showlegend: true,
                margin: { t: 50, r: 50, b: 50, l: 50 },
                height: 280
            };

            Plotly.newPlot('roc-plot', traces, layout, {responsive: true});
        }

        function simulateAtThreshold(t) {
            const actualPositives = Math.round(totalSamples * positiveRate);
            const actualNegatives = totalSamples - actualPositives;

            // Simplified simulation for ROC curve
            let tp = Math.round(actualPositives * (1.2 - t)); // Higher threshold = lower recall
            let fn = actualPositives - tp;
            let fp = Math.round(actualNegatives * (t - 0.2)); // Higher threshold = lower FPR
            let tn = actualNegatives - fp;

            // Ensure non-negative values
            tp = Math.max(0, Math.min(actualPositives, tp));
            fn = actualPositives - tp;
            fp = Math.max(0, Math.min(actualNegatives, fp));
            tn = actualNegatives - fp;

            return { tp, fp, fn, tn };
        }

        // Initialize
        updateMetrics();
        updateROCCurve();

        // Update threshold indicator position
        document.getElementById('threshold-indicator').style.left = '50%';
    </script>
</body>
</html>